#!/bin/bash

display_changes=0
config_changes=0
miral_kiosk_display="$SNAP_DATA/miral-kiosk.display"
miral_kiosk_config="$SNAP_DATA/miral-kiosk.config"

# Ensure we have a config file with the fixed options
if [ ! -e "${miral_kiosk_config}" ]; then
cat <<EOT > "${miral_kiosk_config}"
arw-file=
console-provider=vt
EOT
let config_changes+=1
fi

# As mir-kiosk HAS to run mesa-kms we can safely override the probe for KMS everywhere.
# This ensures the best possible diagnostics whenever we fail to start.
env_hacks=$(sed -n 's/^env-hacks=\(.*\)$/\1/p' ${miral_kiosk_config})
if [[ ! ${env_hacks} =~ .*MIR_MESA_KMS_DISABLE_MODESET_PROBE* ]]
then
  sed --in-place '/^env-hacks=/d' ${miral_kiosk_config}
  env_hacks=env-hacks=${env_hacks}:MIR_MESA_KMS_DISABLE_MODESET_PROBE
  echo ${env_hacks/=:/=} >> "${miral_kiosk_config}"
  let config_changes+=1
fi

# display-config
if display_config=$(snapctl get display-config); then
  if [ -n "${display_config}" ]; then
    echo "# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN" > "${miral_kiosk_display}~"
    echo "# USE 'snap set mir-kiosk display-config=...' INSTEAD"              >> "${miral_kiosk_display}~"
    echo ""                                                                   >> "${miral_kiosk_display}~"
    echo "${display_config}"                                                  >> "${miral_kiosk_display}~"
    if [ -e "${miral_kiosk_display}" ]; then
      if ! diff "${miral_kiosk_display}~" "${miral_kiosk_display}" > /dev/null; then
        mv "${miral_kiosk_display}"  "${miral_kiosk_display}.save"
        mv "${miral_kiosk_display}~" "${miral_kiosk_display}"
        let display_changes+=1
      else
        rm "${miral_kiosk_display}~"
      fi
    else
      mv "${miral_kiosk_display}~" "${miral_kiosk_display}"
      let display_changes+=1
    fi
  else
    if [ -e "${miral_kiosk_display}" ]; then
      if grep "# USE 'snap set mir-kiosk display-config=...' INSTEAD" "${miral_kiosk_display}"; then
        mv "${miral_kiosk_display}"  "${miral_kiosk_display}.save"
        let display_changes+=1
      fi
    fi
  fi
fi

# display-layout
display_layout=$(snapctl get display-layout)
if [ -n "${display_layout}" ]; then
  if [ -e "${miral_kiosk_display}" ]; then
    if [ -z "$(grep "^  ${display_layout}:" "${miral_kiosk_display}")" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${miral_kiosk_display}:"
      echo "---"
      cat "${miral_kiosk_display}"
      echo "---"
      exit 1
    fi
  else
    if [ "${display_layout}" != "default" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${miral_kiosk_display}:"
      echo "---"
      cat "${miral_kiosk_display}"
      echo "---"
      exit 1
    fi
  fi

  if [ "display-layout=${display_layout}" != "$(grep \^display-layout= ${miral_kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^display-layout=/d' ${miral_kiosk_config}
    else
      sed --in-place=.save '/^display-layout=/d' ${miral_kiosk_config}
    fi
    echo display-layout=${display_layout} >> ${miral_kiosk_config}
    let config_changes+=1
  fi
fi

# vt
vt=$(snapctl get vt)
if [ -n "${vt}" ]; then
  if [ -n "${vt//[0-9]}" ] || [ ! -e "/dev/tty$vt" ]; then
    echo "ERROR: '$vt' is not a valid VT"
    exit 1
  fi

  if [ "vt=${vt}" != "$(grep vt= ${miral_kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^vt/d' ${miral_kiosk_config}
    else
      sed --in-place=.save '/^vt/d' ${miral_kiosk_config}
    fi
    echo vt=${vt} >> ${miral_kiosk_config}
    let config_changes+=1
  fi
fi

# cursor
cursor=$(snapctl get cursor)
if [ -n "${cursor}" ]; then
  if [[ ! "${cursor}" =~ ^(auto|none|software)$ ]]; then
    echo "ERROR: '$cursor' is not a valid cursor option (auto|none|software)"
    exit 1
  fi

  if [ "${cursor}" == "none" ]; then
    cursor="null"
  fi

  if [ "cursor=${cursor}" != "$(grep cursor= ${miral_kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^cursor/d' ${miral_kiosk_config}
    else
      sed --in-place=.save '/^cursor/d' ${miral_kiosk_config}
    fi
    echo cursor=${cursor} >> ${miral_kiosk_config}
    let config_changes+=1
  fi
fi

# show-splash 
showsplash=$(snapctl get show-splash)
if [ -n "${showsplash}" ]; then
  if [[ ! "${showsplash}" =~ ^(true|false)$ ]]; then
    echo "ERROR: '$showsplash' is not a valid cursor option (true|false)"
    exit 1
  fi

  if [ "show-splash=${showsplash}" != "$(grep show-splash= ${miral_kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^show-splash/d' ${miral_kiosk_config}
    else
      sed --in-place=.save '/^show-splash/d' ${miral_kiosk_config}
    fi
    echo show-splash=${showsplash} >> ${miral_kiosk_config}
    let config_changes+=1
  fi
fi

if [ "$(snapctl get daemon)" = "true" ]; then
  if snapctl services ${SNAP_INSTANCE_NAME}.daemon | grep -q inactive; then
    snapctl start --enable $SNAP_INSTANCE_NAME.daemon 2>&1 || true
  elif [ $(($config_changes+$display_changes)) -gt 0 ]; then
    snapctl restart $SNAP_INSTANCE_NAME || true
  fi
else
  snapctl stop --disable $SNAP_INSTANCE_NAME.daemon 2>&1 || true
fi
